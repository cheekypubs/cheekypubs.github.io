name: Edit story from dispatch

on:
  repository_dispatch:
    types: [story-edit]

permissions:
  contents: write

jobs:
  edit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update story file
        uses: actions/github-script@v6
        with:
          script: |
            const payload = context.payload.client_payload || {};
            const filepath = (payload.filepath || '').trim();
            const content = payload.content || '';

            if (!filepath || !filepath.startsWith('_stories/') || filepath.includes('..')) {
              core.setFailed('Invalid filepath: ' + filepath);
              return;
            }

            const fs = require('fs');

            if (!fs.existsSync(filepath)) {
              core.setFailed('File not found: ' + filepath);
              return;
            }

            fs.writeFileSync(filepath, content.trimEnd() + '\n');
            core.info('Updated: ' + filepath);

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add _stories/*.md
          git commit -m "Edit story: ${{ github.event.client_payload.title }}" || echo "No changes to commit"
          git push
